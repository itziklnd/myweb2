{% extends "base.html" %} {% block title %}Home{% endblock %} {% block content
%}
<h1 class="text-center">Tasks</h1>

<div class="border rounded p-4 mb-4 shadow-sm bg-white">
  <form method="POST" action="/add-task">
    <div class="mt-4">
      <h2>ניהול משימות</h2>
      <input
        type="text"
        name="task-desc"
        id="task-desc"
        class="form-control"
        placeholder="תיאור משימה"
        required
      />
      <input
        type="number"
        name="task-points"
        id="task-points"
        class="form-control mt-2"
        placeholder="נקודות"
        min="1"
        required
      />
    </div>
    <div class="text-center">
      <button type="submit" class="btn btn-success mt-3">הוסף משימה</button>
    </div>
  </form>

  <h3 class="mt-3 mb-4 text-center">רשימת משימות</h3>
  <ul id="task-list" class="list-group">
    {% for note in notes %}
    <li
      class="list-group-item d-flex justify-content-between align-items-center bg-light border-0 mb-2 rounded"
      data-note-id="{{ note.id }}"
    >
      <span>{{ note.data }} - {{ note.points }} נקודות (זמין)</span>
      <button
        type="button"
        class="btn btn-danger btn-sm"
        onclick="deleteNote({{ note.id }})"
      >
        קח משימה
      </button>
    </li>
    {% endfor %}
  </ul>

  <h3 class="mt-4">לוח ניקוד</h3>
  <ul id="points-board" class="list-group">
    {% for user in users %}
    <li
      class="list-group-item d-flex justify-content-between align-items-center bg-light border-0 mb-2 rounded"
    >
      <span>{{ user.username }} - {{ user.points }}</span>
    </li>
    {% endfor %}
  </ul>

  <div id="admin-section" class="d-none mt-4">
    <h2>ממשק ניהול</h2>
    <input
      type="password"
      id="admin-password"
      class="form-control"
      placeholder="סיסמת מנהל"
    />
    <button class="btn btn-danger mt-2" onclick="adminLogin()">כניסה</button>
    <button class="btn btn-warning mt-2" onclick="logoutAdmin()">
      התנתקות
    </button>
    <button class="btn btn-warning mt-2" onclick="resetPoints()">
      איפוס נקודות
    </button>
    <button class="btn btn-danger mt-2" onclick="resetDatabase()">
      איפוס הכל
    </button>
  </div>

  <button class="btn btn-warning mt-4" onclick="openAdminLogin()">
    כניסה למנהל
  </button>

  {% if admin %}
  <p class="mt-4 text-center text-success">אתה אדמין</p>
  {% endif %}
</div>

<script>
  function openAdminLogin() {
    document.getElementById("admin-section").classList.toggle("d-none");
  }

  function adminLogin() {
    let password = document.getElementById("admin-password").value;
    if (password === "1234") {
      alert("Welcome, Admin!");
      fetch("/admin-login", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
          "admin-password": password,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            document.getElementById("admin-section").classList.add("d-none");
            document.querySelector("p.text-success").style.display = "block";
            document.getElementById("admin-section").classList.remove("d-none");
          }
        });
    } else {
      alert("Incorrect password");
    }
  }

  function logoutAdmin() {
    fetch("/logout-admin", {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          document.querySelector("p.text-success").style.display = "none";
          document.getElementById("admin-section").classList.add("d-none");
        }
      });
  }

  function resetPoints() {
    fetch("/reset-points", {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("נקודות אופסו בהצלחה");
          location.reload();
        } else {
          alert("אירעה שגיאה באיפוס הנקודות.");
        }
      });
  }

  function resetDatabase() {
    fetch("/reset-database", {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("המערכת אופסה בהצלחה");
          location.reload();
        } else {
          alert("אירעה שגיאה באיפוס המערכת.");
        }
      });
  }

  function deleteNote(noteId) {
    fetch("/delete-note", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ noteId: noteId }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          document.querySelector(`li[data-note-id="${noteId}"]`).remove();
        } else {
          alert("Failed to delete the note.");
        }
      });
  }
</script>
{% endblock %}
